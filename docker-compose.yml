version: "3.8"

services:
  img-optimize:
    build: .
    image: img-optimize:latest
    container_name: img-optimize
    depends_on:
      - redis
    ports:
      # Host 3000 -> Container 80 (nginx) -> Node 3000
      - "3000:80"
    environment:
      # Redis connection (container name used as host)
      REDIS_HOST: 172.17.0.1
      REDIS_PORT: 16379

      # App behaviour (values can be overridden via host .env)
      ALLOWED_DOMAINS: ${ALLOWED_DOMAINS}
      ORIGIN_TIMEOUT_MS: ${ORIGIN_TIMEOUT_MS:-5000}
      ORIGIN_MAX_BYTES: ${ORIGIN_MAX_BYTES:-10485760}
      OUTPUT_MAX_BYTES: ${OUTPUT_MAX_BYTES:-10485760}
      SHARP_MAX_PIXELS: ${SHARP_MAX_PIXELS:-64000000}

      REDIS_TTL_SECONDS: ${REDIS_TTL_SECONDS:-3600}
      LOCK_TTL_SECONDS: ${LOCK_TTL_SECONDS:-30}
      LOCK_WAIT_TIMEOUT_MS: ${LOCK_WAIT_TIMEOUT_MS:-10000}
      LOCK_RETRY_DELAY_MS: ${LOCK_RETRY_DELAY_MS:-150}
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # Optional: Redis password/db (match .env.production.example if used)
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}

  redis:
    image: redis:7-alpine
    container_name: img-redis
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      # Optional: expose Redis to host for debugging
      - "16379:6379"
    volumes:
      - redis-data:/data

volumes:
  redis-data:

